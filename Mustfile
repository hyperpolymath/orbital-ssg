# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# Mustfile â€” orbital-ssg mandatory checks and recipes

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY CHECKS (run before commit/push)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.pre-commit]
description = "Pre-commit checks"
commands = [
    "deno fmt --check adapters/ tests/",
    "deno lint adapters/ tests/",
    "deno test --allow-run tests/"
]

[must.pre-push]
description = "Pre-push validation"
commands = [
    "deno lint adapters/",
    "deno test --allow-run --allow-read tests/",
    "just security-scan"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUDIT RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.audit]
description = "Full security and quality audit"
commands = [
    "echo 'ğŸ” Running full audit...'",
    "just security-scan",
    "deno info",
    "echo 'âœ… Audit complete'"
]

[must.audit.security]
description = "Security-focused audit"
commands = [
    "echo 'ğŸ›¡ï¸ Security audit...'",
    "grep -rn 'sanitize' adapters/ | wc -l",
    "grep -rn 'eval\\|exec\\|spawn' adapters/ || true",
    "echo 'âœ… Security audit complete'"
]

[must.audit.spdx]
description = "Check SPDX headers"
commands = [
    "echo 'ğŸ“œ Checking SPDX headers...'",
    "for f in adapters/*.js; do head -2 \"$f\" | grep -q 'SPDX' || echo \"Missing SPDX: $f\"; done",
    "echo 'âœ… SPDX check complete'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPENDENCY MANAGEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.deps]
description = "Check and update dependencies"
commands = [
    "echo 'ğŸ“¦ Checking dependencies...'",
    "deno info",
    "echo 'âœ… Dependencies checked'"
]

[must.deps.outdated]
description = "Check for outdated dependencies"
commands = [
    "echo 'ğŸ“¦ Checking for outdated deps...'",
    "cat deno.json | grep -A20 'imports'",
    "echo 'âœ… Check complete'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SYNC RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.sync]
description = "Sync with poly-ssg-mcp hub"
commands = [
    "echo 'ğŸ”„ Sync status...'",
    "echo 'Hub: poly-ssg-mcp'",
    "echo 'Direction: bidirectional'",
    "echo 'Run: just sync-from-hub or just sync-to-hub'"
]

[must.sync.verify]
description = "Verify sync integrity"
commands = [
    "echo 'ğŸ” Verifying adapter integrity...'",
    "ls -la adapters/*.js | wc -l",
    "echo 'âœ… Verification complete'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUALITY GATES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.quality]
description = "Full quality gate check"
commands = [
    "echo 'ğŸ¯ Running quality gates...'",
    "deno fmt --check adapters/ tests/",
    "deno lint adapters/ tests/",
    "deno test --allow-run tests/",
    "echo 'âœ… All quality gates passed'"
]

[must.quality.coverage]
description = "Check test coverage meets minimum"
commands = [
    "echo 'ğŸ“Š Checking coverage...'",
    "deno test --allow-run --coverage=coverage/ tests/",
    "deno coverage coverage/ --lcov > coverage/lcov.info",
    "echo 'âœ… Coverage report generated'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CI/CD RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.ci]
description = "Run CI pipeline locally"
commands = [
    "echo 'ğŸ”„ Running CI pipeline...'",
    "just check",
    "just test",
    "just security-scan",
    "echo 'âœ… CI pipeline complete'"
]

[must.ci.matrix]
description = "Test across environments"
commands = [
    "echo 'ğŸ§ª Matrix testing...'",
    "just container-test",
    "echo 'âœ… Matrix tests complete'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RELEASE GATES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.release]
description = "Pre-release validation"
commands = [
    "echo 'ğŸ“¦ Pre-release checks...'",
    "just test-all",
    "just security-scan",
    "just docs",
    "echo 'âœ… Ready for release'"
]

[must.release.checklist]
description = "Release checklist"
commands = [
    "echo 'ğŸ“‹ Release Checklist'",
    "echo '==================='",
    "echo '[ ] Version updated in deno.json'",
    "echo '[ ] Version updated in STATE.scm'",
    "echo '[ ] CHANGELOG.md updated'",
    "echo '[ ] All tests passing'",
    "echo '[ ] Security scan clean'",
    "echo '[ ] Documentation generated'",
    "echo '[ ] Git tag created'"
]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ADAPTER VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[must.adapter.validate]
description = "Validate adapter structure"
commands = [
    "echo 'ğŸ” Validating adapter structure...'",
    "for f in adapters/*.js; do",
    "  grep -q 'export const name' \"$f\" || echo \"Missing name: $f\"",
    "  grep -q 'export const language' \"$f\" || echo \"Missing language: $f\"",
    "  grep -q 'export async function connect' \"$f\" || echo \"Missing connect: $f\"",
    "  grep -q 'export const tools' \"$f\" || echo \"Missing tools: $f\"",
    "done",
    "echo 'âœ… Validation complete'"
]

[must.adapter.security]
description = "Validate adapter security"
commands = [
    "echo 'ğŸ›¡ï¸ Validating adapter security...'",
    "echo 'Checking for sanitization in string-interpolating adapters...'",
    "grep -l '\\${' adapters/*.js | while read f; do",
    "  grep -q 'sanitize' \"$f\" || echo \"âš ï¸ Missing sanitization: $f\"",
    "done",
    "echo 'âœ… Security validation complete'"
]
